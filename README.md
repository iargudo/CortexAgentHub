# üß† CortexAgentHub - Multi-Channel AI Orchestration Platform

**CortexAgentHub** es una plataforma de orquestaci√≥n de IA de nivel empresarial que conecta m√∫ltiples canales de comunicaci√≥n (WhatsApp, Telegram, WebChat, Email) con m√∫ltiples proveedores de LLM (OpenAI, Anthropic, Ollama, Google, HuggingFace) a trav√©s de una arquitectura centralizada de agentes inteligentes.

> üöÄ **Estado**: Sistema 100% funcional en producci√≥n con sistema de tools din√°micas, agentes especializados, multi-instancia WhatsApp y UI administrativa completa.

---

## üíº ¬øPor Qu√© CortexAgentHub?

### **El Problema que Resuelve**

Las empresas modernas enfrentan desaf√≠os cr√≠ticos en atenci√≥n al cliente:
- üì± Clientes dispersos en m√∫ltiples canales (WhatsApp, Telegram, Email, Web)
- ‚è∞ Expectativa de respuesta inmediata 24/7
- üí∞ Costos elevados de personal de soporte
- üîÑ Informaci√≥n fragmentada entre sistemas
- üìä Dificultad para escalar operaciones

### **La Soluci√≥n CortexAgentHub**

**Una √∫nica plataforma** que permite:

1. **Automatizaci√≥n Inteligente** - Agentes AI especializados que responden instant√°neamente
2. **Omnicanalidad Real** - Un mismo agente funciona en WhatsApp, Telegram, Web y Email
3. **Integraci√≥n Total** - Se conecta con CRMs, ERPs, bases de datos y servicios externos
4. **Escalabilidad Infinita** - Atiende a 1 o 100,000 clientes simult√°neamente
5. **Reducci√≥n de Costos** - Hasta 80% menos en costos operativos

### **ROI T√≠pico**

| M√©trica | Sin CortexAgentHub | Con CortexAgentHub | Mejora |
|---------|---------------|---------------|--------|
| **Tiempo de Respuesta** | 15-30 min | < 5 seg | **99%** ‚¨áÔ∏è |
| **Disponibilidad** | 9am-6pm (L-V) | 24/7/365 | **300%** ‚¨ÜÔ∏è |
| **Costo por Interacci√≥n** | $5-10 | $0.10-0.50 | **95%** ‚¨áÔ∏è |
| **Tasa de Resoluci√≥n** | 60-70% | 85-95% | **30%** ‚¨ÜÔ∏è |
| **Clientes Atendidos/hora** | 5-10 | Ilimitado | **‚àû** ‚¨ÜÔ∏è |

### **Ventajas Competitivas**

‚úÖ **Open Source** - Sin vendor lock-in, total control  
‚úÖ **Self-Hosted** - Datos en tu infraestructura  
‚úÖ **Multi-LLM** - No dependes de un solo proveedor  
‚úÖ **Modelos Locales** - Ollama para privacidad total  
‚úÖ **Tools Din√°micas** - Crea funcionalidades sin programar  
‚úÖ **Multi-Instancia** - Un sistema, m√∫ltiples l√≠neas de negocio  

---

## üè¢ Casos de Uso por Industria

### **üõí Retail & E-Commerce**

**Problema**: Consultas repetitivas sobre productos, inventario, env√≠os  
**Soluci√≥n**: Agente de ventas automatizado

**Implementaci√≥n**:
```
Agente: "Asistente de Ventas"
Canal: WhatsApp + WebChat
Tools: 
  - search_products (buscar cat√°logo)
  - check_stock (verificar inventario)
  - calculate_shipping (calcular env√≠o)
  - send_leadbox_lead (registrar prospecto)
  - create_order (generar pedido)

Resultados:
‚úÖ 90% de consultas resueltas sin humanos
‚úÖ Ventas 24/7 sin personal nocturno
‚úÖ Aumento del 40% en conversi√≥n
‚úÖ Reducci√≥n del 70% en tiempo de respuesta
```

**Ejemplo Real**: Tienda de muebles con 5,000 productos
- Antes: 3 personas atendiendo WhatsApp (9am-6pm)
- Despu√©s: 1 persona supervisando, AI atendiendo 24/7
- Resultado: +150 ventas/mes, -$4,000/mes en n√≥mina

---

### **üè• Salud & Cl√≠nicas**

**Problema**: Agendamiento manual, recordatorios, consultas b√°sicas  
**Soluci√≥n**: Asistente m√©dico virtual

**Implementaci√≥n**:
```
Agente: "Asistente de Citas"
Canal: WhatsApp + Telegram
Tools:
  - check_availability (ver agenda m√©dicos)
  - schedule_appointment (agendar cita)
  - cancel_appointment (cancelar cita)
  - send_reminder (enviar recordatorio)
  - check_insurance (verificar seguro)

Resultados:
‚úÖ 85% de citas agendadas autom√°ticamente
‚úÖ 50% reducci√≥n en no-shows (recordatorios)
‚úÖ Liberaci√≥n de 2 recepcionistas
‚úÖ Atenci√≥n 24/7 para urgencias
```

**Ejemplo Real**: Cl√≠nica dental con 3 consultorios
- Antes: 2 recepcionistas full-time
- Despu√©s: 1 recepcionista + AI
- Resultado: +30% citas/mes, -$2,500/mes en n√≥mina

---

### **üè¶ Bancos & Seguros**

**Problema**: Consultas de saldos, movimientos, cotizaciones  
**Soluci√≥n**: Agente financiero automatizado

**Implementaci√≥n**:
```
Agente: "Asistente Financiero"
Canal: WebChat + WhatsApp (cifrado)
Tools:
  - check_balance (consultar saldo)
  - get_movements (listar movimientos)
  - calculate_loan (calcular pr√©stamo)
  - generate_statement (generar estado de cuenta)
  - report_fraud (reportar fraude)

Resultados:
‚úÖ 95% de consultas b√°sicas automatizadas
‚úÖ Cumplimiento de regulaciones (logs completos)
‚úÖ Seguridad con Ollama local (datos privados)
‚úÖ Reducci√≥n de 80% en llamadas al call center
```

**Ejemplo Real**: Cooperativa de ahorro con 50,000 socios
- Antes: Call center de 20 personas
- Despu√©s: 5 personas + AI
- Resultado: -$180,000/a√±o, +95% satisfacci√≥n

---

### **üè® Hoteler√≠a & Turismo**

**Problema**: Reservas, consultas de disponibilidad, informaci√≥n tur√≠stica  
**Soluci√≥n**: Concierge virtual

**Implementaci√≥n**:
```
Agente: "Concierge Virtual"
Canal: WhatsApp + WebChat + Email
Tools:
  - check_room_availability (ver habitaciones)
  - create_reservation (hacer reserva)
  - suggest_activities (recomendar tours)
  - send_directions (enviar ubicaci√≥n)
  - calculate_total (calcular precio total)

Resultados:
‚úÖ Reservas 24/7 en 4 idiomas
‚úÖ 70% de consultas pre-viaje automatizadas
‚úÖ Upselling automatizado (+20% revenue/room)
‚úÖ Satisfacci√≥n del hu√©sped +40%
```

**Ejemplo Real**: Hotel boutique 30 habitaciones
- Antes: Recepci√≥n atendiendo llamadas y WhatsApp
- Despu√©s: AI filtrando y pre-calificando
- Resultado: +25% occupancy, +$15,000/mes revenue

---

### **üè¢ Empresas B2B & SaaS**

**Problema**: Soporte t√©cnico repetitivo, onboarding, documentaci√≥n  
**Soluci√≥n**: Agente de soporte t√©cnico

**Implementaci√≥n**:
```
Agente: "Soporte T√©cnico"
Canal: WebChat + Email + Telegram
Tools:
  - search_knowledge_base (buscar en docs)
  - create_ticket (crear ticket)
  - check_service_status (ver estado servicios)
  - send_tutorial (enviar tutorial)
  - escalate_to_human (escalar a humano)

Resultados:
‚úÖ 75% de tickets resueltos autom√°ticamente
‚úÖ Tiempo de primera respuesta: 5 seg vs 2 horas
‚úÖ Documentaci√≥n siempre actualizada y accesible
‚úÖ Reducci√≥n de 60% en carga del equipo
```

**Ejemplo Real**: Empresa SaaS con 500 clientes B2B
- Antes: 4 ingenieros de soporte
- Despu√©s: 2 ingenieros + AI
- Resultado: -$120,000/a√±o, NPS +30 puntos

---

### **üè´ Educaci√≥n & Academia**

**Problema**: Consultas administrativas, informaci√≥n de cursos, matr√≠culas  
**Soluci√≥n**: Asistente acad√©mico

**Implementaci√≥n**:
```
Agente: "Asistente Acad√©mico"
Canal: WhatsApp + WebChat + Email
Tools:
  - search_courses (buscar cursos)
  - check_schedule (ver horarios)
  - enroll_student (matricular)
  - send_syllabus (enviar programa)
  - answer_faq (responder FAQ)

Resultados:
‚úÖ 90% de consultas administrativas automatizadas
‚úÖ Proceso de matr√≠cula 24/7
‚úÖ Liberaci√≥n de personal administrativo
‚úÖ Informaci√≥n consistente y actualizada
```

**Ejemplo Real**: Instituto con 2,000 estudiantes
- Antes: 3 personas en ventanilla de informaci√≥n
- Despu√©s: 1 persona + AI
- Resultado: -$40,000/a√±o, +50% inscripciones online

---

### **üè≠ Manufactura & Distribuci√≥n**

**Problema**: Seguimiento de pedidos, cotizaciones, disponibilidad  
**Soluci√≥n**: Agente de atenci√≥n a distribuidores

**Implementaci√≥n**:
```
Agente: "Atenci√≥n a Distribuidores"
Canal: WhatsApp + Email
Tools:
  - check_order_status (rastrear pedido)
  - generate_quote (generar cotizaci√≥n)
  - check_inventory (ver inventario)
  - schedule_delivery (agendar entrega)
  - report_issue (reportar problema)

Resultados:
‚úÖ Distribuidores consultan 24/7
‚úÖ 80% de cotizaciones autom√°ticas
‚úÖ Reducci√≥n de errores en pedidos
‚úÖ Mejor relaci√≥n con distribuidores
```

**Ejemplo Real**: Fabricante con 200 distribuidores
- Antes: 2 ejecutivos de cuenta
- Despu√©s: 1 ejecutivo + AI
- Resultado: -$60,000/a√±o, +35% volumen pedidos

---

### **üöó Automotriz & Servicios**

**Problema**: Agendamiento de citas, consultas t√©cnicas, seguimiento  
**Soluci√≥n**: Agente de servicio automotriz

**Implementaci√≥n**:
```
Agente: "Servicio Automotriz"
Canal: WhatsApp + WebChat
Tools:
  - schedule_service (agendar servicio)
  - estimate_repair (estimar reparaci√≥n)
  - check_warranty (verificar garant√≠a)
  - order_parts (pedir repuestos)
  - send_invoice (enviar factura)

Resultados:
‚úÖ Agendamiento 24/7 sin llamadas
‚úÖ 70% de consultas t√©cnicas resueltas
‚úÖ Recordatorios automatizados de mantenimiento
‚úÖ +40% retenci√≥n de clientes
```

**Ejemplo Real**: Taller mec√°nico con 3 mec√°nicos
- Antes: Due√±o atendiendo tel√©fono
- Despu√©s: AI filtrando y agendando
- Resultado: +20 servicios/mes, +$8,000/mes

---

## üéØ Escenarios de Implementaci√≥n

### **Startup con Presupuesto Limitado**

**Perfil**: 
- Equipo de 5 personas
- 100-500 clientes/mes
- Presupuesto tech: $500/mes

**Soluci√≥n CortexAgentHub**:
```
Infraestructura:
- VPS: $20/mes (DigitalOcean/Hetzner)
- PostgreSQL + Redis: Incluido
- Ollama: Gratis (llama3.2:latest)
- WhatsApp: $0 (UltrMsg free tier)

Total: $20/mes vs $5,000/mes contratando personal

ROI: 99.6% ahorro mensual
```

---

### **Empresa Mediana en Crecimiento**

**Perfil**:
- 50-200 empleados
- 5,000-20,000 clientes/mes
- Presupuesto tech: $5,000/mes

**Soluci√≥n CortexAgentHub**:
```
Infraestructura:
- VPS Dedicado: $200/mes
- PostgreSQL Managed: $100/mes
- Redis Managed: $50/mes
- OpenAI API: $1,000/mes (GPT-4)
- WhatsApp Business: $500/mes

Total: $1,850/mes vs $25,000/mes con equipo de 10 personas

ROI: 92.6% ahorro mensual
```

---

### **Corporaci√≥n Multi-Nacional**

**Perfil**:
- 1,000+ empleados
- 100,000+ clientes/mes
- Presupuesto tech: Ilimitado

**Soluci√≥n CortexAgentHub**:
```
Infraestructura:
- Kubernetes Cluster: $2,000/mes
- PostgreSQL HA: $500/mes
- Redis Cluster: $300/mes
- Multi-LLM (OpenAI+Claude): $10,000/mes
- WhatsApp Enterprise: $2,000/mes

Total: $14,800/mes vs $500,000/mes con call center de 200 personas

ROI: 97% ahorro mensual
```

---

## üí° Beneficios Medibles

### **Operacionales**

| Beneficio | Impacto | Tiempo |
|-----------|---------|--------|
| Reducci√≥n de tiempo de respuesta | -95% | Inmediato |
| Aumento de disponibilidad | +200% | D√≠a 1 |
| Reducci√≥n de errores humanos | -80% | 1 semana |
| Escalabilidad instant√°nea | +‚àû% | Ilimitado |
| Consistencia en respuestas | 100% | D√≠a 1 |

### **Financieros**

| Beneficio | Rango T√≠pico | Break-even |
|-----------|--------------|------------|
| Reducci√≥n de costos operativos | 70-90% | 1-3 meses |
| Aumento en conversi√≥n | 20-50% | 2-4 meses |
| Reducci√≥n de churn | 15-30% | 3-6 meses |
| Aumento en ticket promedio | 10-25% | 2-4 meses |
| ROI anual | 300-800% | 1 a√±o |

### **Experiencia del Cliente**

| M√©trica | Antes | Despu√©s | Mejora |
|---------|-------|---------|--------|
| NPS (Net Promoter Score) | 30-40 | 60-80 | +100% |
| CSAT (Customer Satisfaction) | 3.5/5 | 4.7/5 | +34% |
| FCR (First Contact Resolution) | 60% | 90% | +50% |
| Abandonment Rate | 30% | 5% | -83% |

---

## üîÑ Roadmap de Implementaci√≥n

### **Fase 1: Piloto (Semana 1-2)**
- ‚úÖ Instalaci√≥n en servidor de desarrollo
- ‚úÖ Configuraci√≥n de 1 canal (WebChat o WhatsApp)
- ‚úÖ Creaci√≥n de 1 agente b√°sico (FAQ)
- ‚úÖ Pruebas con equipo interno
- ‚úÖ Ajustes basados en feedback

**Output**: Sistema funcional con 100 interacciones de prueba

---

### **Fase 2: Beta Controlada (Semana 3-4)**
- ‚úÖ Apertura a 10-20% de clientes reales
- ‚úÖ Monitoreo intensivo de conversaciones
- ‚úÖ Ajuste de system prompts
- ‚úÖ Creaci√≥n de 2-3 tools espec√≠ficas
- ‚úÖ Definici√≥n de KPIs

**Output**: 500-1000 conversaciones reales analizadas

---

### **Fase 3: Lanzamiento Gradual (Mes 2)**
- ‚úÖ Expansi√≥n a 50% de tr√°fico
- ‚úÖ Configuraci√≥n de m√∫ltiples canales
- ‚úÖ Creaci√≥n de agentes especializados
- ‚úÖ Integraci√≥n con CRM/ERP
- ‚úÖ Training del equipo de soporte

**Output**: Sistema manejando mayor√≠a del tr√°fico

---

### **Fase 4: Operaci√≥n Plena (Mes 3+)**
- ‚úÖ 100% de consultas pasan por AI
- ‚úÖ Escalamiento autom√°tico
- ‚úÖ Optimizaci√≥n continua de agentes
- ‚úÖ Expansi√≥n de integraciones
- ‚úÖ An√°lisis de datos y mejoras

**Output**: Sistema aut√≥nomo con supervisi√≥n m√≠nima

---

## üìã Tabla de Contenidos

- [Valor de Negocio](#-por-qu√©-cortexmcp)
- [Casos de Uso por Industria](#-casos-de-uso-por-industria)
- [Escenarios de Implementaci√≥n](#-escenarios-de-implementaci√≥n)
- [Beneficios Medibles](#-beneficios-medibles)
- [Roadmap de Implementaci√≥n](#-roadmap-de-implementaci√≥n)
- [Caracter√≠sticas Principales](#-caracter√≠sticas-principales)
- [Arquitectura del Sistema](#Ô∏è-arquitectura-del-sistema)
- [Estructura del Monorepo](#-estructura-del-monorepo)
- [Tecnolog√≠as Utilizadas](#-tecnolog√≠as-utilizadas)
- [Requisitos Previos](#-requisitos-previos)
- [Instalaci√≥n R√°pida](#-instalaci√≥n-r√°pida)
- [Configuraci√≥n](#Ô∏è-configuraci√≥n)
- [Uso del Sistema](#-uso-del-sistema)
- [Sistema de Tools Din√°micas](#-sistema-de-tools-din√°micas)
- [Agentes Especializados](#-agentes-especializados)
- [Multi-Instancia WhatsApp](#-multi-instancia-whatsapp)
- [API y Webhooks](#-api-y-webhooks)
- [Desarrollo](#-desarrollo)
- [Troubleshooting](#-troubleshooting)
- [Licencia](#-licencia)

---

## üåü Caracter√≠sticas Principales

### **Orquestaci√≥n Multi-Canal**
- ‚úÖ **WhatsApp** - Integraci√≥n con UltrMsg y Twilio
- ‚úÖ **Telegram** - Bot API completo con inline keyboards
- ‚úÖ **WebChat** - WebSocket en tiempo real con JWT
- ‚úÖ **Email** - SMTP/IMAP con soporte HTML y adjuntos

### **Multi-Provider LLM**
- ‚úÖ **OpenAI** - GPT-4, GPT-4 Turbo, GPT-3.5
- ‚úÖ **Anthropic** - Claude 3.5 Sonnet, Opus, Haiku
- ‚úÖ **Ollama** - Modelos locales (Llama, Mistral, etc.)
- ‚úÖ **Google** - Gemini Pro y Ultra
- ‚úÖ **HuggingFace** - Inference API

### **Sistema de Tools Din√°micas**
- ‚úÖ **100% Database-Driven** - Sin c√≥digo hardcodeado
- ‚úÖ **Editor Monaco** - Syntax highlighting y autocomplete
- ‚úÖ **Hot-Reload** - Cambios instant√°neos sin reiniciar
- ‚úÖ **ExecutionEngine** - Ejecuci√≥n segura de JavaScript
- ‚úÖ **Testing Integrado** - Prueba tools en tiempo real
- ‚úÖ **9 Tools Pre-configuradas** - Weather, Email, Search, etc.

### **Agentes Especializados**
- ‚úÖ **UI Visual** - Configuraci√≥n sin c√≥digo
- ‚úÖ **System Prompts** - Personalizaci√≥n de comportamiento
- ‚úÖ **Tool Selection** - Asignaci√≥n de herramientas por agente
- ‚úÖ **Routing Inteligente** - Basado en regex y prioridades
- ‚úÖ **Multi-Instancia** - M√∫ltiples n√∫meros WhatsApp/Telegram

### **Admin UI Profesional**
- ‚úÖ **Dashboard** - M√©tricas en tiempo real
- ‚úÖ **Channels** - Gesti√≥n de canales de comunicaci√≥n
- ‚úÖ **LLMs** - Configuraci√≥n de proveedores
- ‚úÖ **Tools** - Editor de herramientas din√°micas
- ‚úÖ **Agents** - Configuraci√≥n visual de agentes
- ‚úÖ **Playground** - Pruebas interactivas
- ‚úÖ **Analytics** - Estad√≠sticas y logs

### **Caracter√≠sticas T√©cnicas Avanzadas**
- ‚úÖ **Load Balancer** - Round-robin, least-latency, least-cost
- ‚úÖ **Circuit Breaker** - Recuperaci√≥n autom√°tica de fallos
- ‚úÖ **Rate Limiting** - Por usuario y por tool
- ‚úÖ **Context Management** - Redis + PostgreSQL
- ‚úÖ **Vector Search** - pgvector para embeddings
- ‚úÖ **Cost Tracking** - Seguimiento de costos por token
- ‚úÖ **BullMQ Queues** - Procesamiento as√≠ncrono

---

## üèóÔ∏è Arquitectura del Sistema

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                         CANALES DE COMUNICACI√ìN                       ‚îÇ
‚îÇ  WhatsApp (UltrMsg) ‚îÇ Telegram ‚îÇ WebChat (WS) ‚îÇ Email (SMTP)        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                           ‚îÇ
                           ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                      WEBHOOKS & API GATEWAY                           ‚îÇ
‚îÇ  POST /webhooks/whatsapp ‚îÇ /telegram ‚îÇ /email                        ‚îÇ
‚îÇ  POST /api/v1/messages/send                                          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                           ‚îÇ
                           ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                   FLOW-BASED MESSAGE ROUTER                           ‚îÇ
‚îÇ  - Selecciona agente basado en canal, regex, prioridad               ‚îÇ
‚îÇ  - Carga configuraci√≥n (LLM, tools, system prompt)                   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                           ‚îÇ
                           ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                      AI ORCHESTRATOR                                  ‚îÇ
‚îÇ  1. Carga contexto de conversaci√≥n (Redis)                           ‚îÇ
‚îÇ  2. Prepara mensaje con historial                                    ‚îÇ
‚îÇ  3. Invoca LLM con tools disponibles                                 ‚îÇ
‚îÇ  4. Ejecuta tools si el LLM lo solicita                              ‚îÇ
‚îÇ  5. Retorna respuesta final                                          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
              ‚îÇ                            ‚îÇ
              ‚ñº                            ‚ñº
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê          ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ   LLM GATEWAY   ‚îÇ          ‚îÇ    MCP SERVER       ‚îÇ
    ‚îÇ                 ‚îÇ          ‚îÇ                     ‚îÇ
    ‚îÇ ‚Ä¢ OpenAI        ‚îÇ          ‚îÇ ‚Ä¢ DynamicToolLoader ‚îÇ
    ‚îÇ ‚Ä¢ Anthropic     ‚îÇ          ‚îÇ ‚Ä¢ ExecutionEngine   ‚îÇ
    ‚îÇ ‚Ä¢ Ollama        ‚îÇ‚óÑ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§ ‚Ä¢ ToolRegistry      ‚îÇ
    ‚îÇ ‚Ä¢ Google        ‚îÇ          ‚îÇ ‚Ä¢ ContextStore      ‚îÇ
    ‚îÇ ‚Ä¢ HuggingFace   ‚îÇ          ‚îÇ ‚Ä¢ PermissionManager ‚îÇ
    ‚îÇ                 ‚îÇ          ‚îÇ                     ‚îÇ
    ‚îÇ Load Balancer   ‚îÇ          ‚îÇ 9 Dynamic Tools     ‚îÇ
    ‚îÇ Circuit Breaker ‚îÇ          ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
              ‚îÇ
              ‚ñº
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ         PERSISTENCIA & CACHE                    ‚îÇ
    ‚îÇ  PostgreSQL + pgvector ‚îÇ Redis + BullMQ         ‚îÇ
    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### **Flujo de Decisi√≥n de Orquestaci√≥n**

```
MENSAJE ENTRANTE
      ‚îÇ
      ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 1. Normalizaci√≥n del Mensaje                                ‚îÇ
‚îÇ    - Channel Adapter convierte a formato interno            ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                         ‚îÇ
                         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 2. FlowBasedMessageRouter                                   ‚îÇ
‚îÇ    Query: orchestration_flows WHERE:                        ‚îÇ
‚îÇ    - channel_type = 'whatsapp'                              ‚îÇ
‚îÇ    - instance_identifier = '593997369006'                   ‚îÇ
‚îÇ    - is_active = true                                       ‚îÇ
‚îÇ    - message REGEX match routing_condition                  ‚îÇ
‚îÇ    ORDER BY: instance_match, priority                       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                         ‚îÇ
                         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 3. Carga Configuraci√≥n del Agente                           ‚îÇ
‚îÇ    - llm_provider: "ollama"                                 ‚îÇ
‚îÇ    - llm_model: "llama3:8b"                                 ‚îÇ
‚îÇ    - system_prompt: "Eres un asistente..."                  ‚îÇ
‚îÇ    - enabled_tools: ["get_weather", "send_leadbox_lead"]    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                         ‚îÇ
                         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 4. AIOrchestrator.processMessage()                          ‚îÇ
‚îÇ    - Carga contexto de Redis                                ‚îÇ
‚îÇ    - Prepara historial de conversaci√≥n                      ‚îÇ
‚îÇ    - Filtra tools por permisos de canal                     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                         ‚îÇ
                         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 5. LLMGateway.complete()                                    ‚îÇ
‚îÇ    - Selecciona provider (ollama)                           ‚îÇ
‚îÇ    - Para Ollama: Inyecta tools en system prompt            ‚îÇ
‚îÇ    - Env√≠a mensaje al LLM                                   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                         ‚îÇ
                         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 6. ¬øEl LLM quiere usar una tool?                            ‚îÇ
‚îÇ    SI: parseToolCalls() detecta JSON tool request           ‚îÇ
‚îÇ    NO: Retorna respuesta directamente                       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
             ‚îÇ SI                    ‚îÇ NO
             ‚ñº                       ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 7. MCPServer.          ‚îÇ    ‚îÇ 9. Respuesta Final   ‚îÇ
‚îÇ    executeTool()       ‚îÇ    ‚îÇ    - Guarda contexto ‚îÇ
‚îÇ    - Valida permisos   ‚îÇ    ‚îÇ    - Env√≠a a canal   ‚îÇ
‚îÇ    - ExecutionEngine   ‚îÇ    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
‚îÇ    - fetch(), logger,  ‚îÇ
‚îÇ      db, utils         ‚îÇ
‚îÇ    - Retorna resultado ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
             ‚îÇ
             ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 8. Segunda llamada al LLM                                   ‚îÇ
‚îÇ    - Incluye resultado de la tool                           ‚îÇ
‚îÇ    - LLM formula respuesta final en lenguaje natural        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                         ‚îÇ
                         ‚ñº
                  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                  ‚îÇ Respuesta Final  ‚îÇ
                  ‚îÇ al Usuario       ‚îÇ
                    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üì¶ Estructura del Monorepo

```
CortexAgentHub/
‚îú‚îÄ‚îÄ packages/
‚îÇ   ‚îú‚îÄ‚îÄ shared/                 # Tipos, constantes, utilidades compartidas
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ types/              # TypeScript types
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ constants/          # LLM costs, error codes
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ utils/              # Logger, helpers
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ mcp-server/             # Implementaci√≥n del MCP Protocol
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ server/             # MCPServer main class
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ context-store/      # Redis + Memory stores
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ tools/              # DynamicToolLoader, ExecutionEngine
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ permissions/        # PermissionManager
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ llm-gateway/            # Gateway unificado de LLMs
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ providers/          # OpenAI, Anthropic, Ollama, Google, HF
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ load-balancer/      # Estrategias de balanceo
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ circuit-breaker/    # Recuperaci√≥n de fallos
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ channel-adapters/       # Adaptadores de canales
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ whatsapp/           # UltrMsg + Twilio
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ telegram/           # Bot API
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ webchat/            # WebSocket server
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ email/              # SMTP/IMAP
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ core/                   # L√≥gica de orquestaci√≥n
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ orchestrator/       # AIOrchestrator
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ router/             # FlowBasedMessageRouter
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ context/            # ContextManager
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ api-service/            # REST API y Webhooks
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ controllers/        # Messages, Webhooks, Admin
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ routes/             # Fastify routes
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ middleware/         # Auth, rate limit, CORS
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ database/               # Migraciones y schemas
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ migrations/         # SQL migration scripts
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ queue-service/          # BullMQ queues
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ workers/            # Message, webhook, email workers
‚îÇ   ‚îÇ
‚îÇ   ‚îî‚îÄ‚îÄ admin-frontend/         # React Admin UI
‚îÇ       ‚îú‚îÄ‚îÄ pages/              # Dashboard, Tools, Agents, etc
‚îÇ       ‚îú‚îÄ‚îÄ components/         # Reutilizables
‚îÇ       ‚îî‚îÄ‚îÄ services/           # API client
‚îÇ
‚îú‚îÄ‚îÄ setup-local.sh              # Script de instalaci√≥n automatizada
‚îú‚îÄ‚îÄ .env.example                # Ejemplo de variables de entorno
‚îî‚îÄ‚îÄ README.md                   # Este archivo
```

---

## üõ†Ô∏è Tecnolog√≠as Utilizadas

### **Backend**
- **Node.js** 18+ - Runtime JavaScript
- **TypeScript** 5.x - Tipado est√°tico
- **Fastify** 4.x - HTTP server de alto rendimiento
- **PNPM Workspaces** - Gesti√≥n de monorepo

### **Base de Datos y Cache**
- **PostgreSQL** 15+ - Base de datos relacional
- **pgvector** - Extensi√≥n para embeddings vectoriales
- **Redis** 7.x - Cache y context store
- **BullMQ** - Cola de trabajos basada en Redis

### **IA y LLMs**
- **OpenAI SDK** - GPT-4, GPT-3.5
- **Anthropic SDK** - Claude 3.5
- **Ollama** - Modelos locales (Llama, Mistral)
- **Google Generative AI** - Gemini
- **HuggingFace Inference** - Modelos open source

### **Frontend**
- **React** 18 - UI library
- **TypeScript** - Tipado est√°tico
- **Vite** - Build tool
- **Tailwind CSS** - Utility-first CSS
- **React Query** - Data fetching y cache
- **Monaco Editor** - Editor de c√≥digo (VS Code)
- **Lucide Icons** - Iconograf√≠a

### **Herramientas de Desarrollo**
- **ESLint** - Linting
- **Prettier** - Code formatting
- **TSC** - TypeScript compiler

---

## üìã Requisitos Previos

### **Software Requerido (macOS)**

```bash
# Node.js 18+
node --version  # v18.0.0 o superior

# PNPM 8+
pnpm --version  # 8.0.0 o superior

# PostgreSQL (con pgvector)
psql --version  # 15.0 o superior
brew list pgvector  # Debe estar instalado

# Redis
redis-cli --version  # 7.0 o superior

# Ollama (opcional, para LLMs locales)
ollama --version  # 0.1.0 o superior
```

### **Instalaci√≥n de Dependencias**

   ```bash
# Instalar Homebrew (si no est√° instalado)
/bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"

# Instalar servicios
brew install postgresql@15
brew install redis
brew install pgvector

# Instalar Ollama
curl https://ollama.ai/install.sh | sh

# Iniciar servicios
brew services start postgresql@15
brew services start redis
ollama serve &
```

---

## üöÄ Instalaci√≥n R√°pida

### **Opci√≥n 1: Instalaci√≥n Automatizada (Recomendado)**

   ```bash
# 1. Clonar repositorio
git clone https://github.com/your-org/cortex-mcp.git
cd cortex-mcp

# 2. Copiar archivo de entorno
cp .env.example .env

# 3. Editar .env con tus credenciales
# M√≠nimo requerido:
#   - DB_NAME=cortexmcp
#   - OLLAMA_BASE_URL=http://localhost:11434
#   - OLLAMA_MODEL=llama3.2:latest

# 4. Ejecutar setup autom√°tico
chmod +x setup-local.sh
./setup-local.sh

# 5. Iniciar sistema
pnpm dev
```

El script `setup-local.sh` realiza:
- ‚úÖ Verifica servicios locales (PostgreSQL, Redis, Ollama)
- ‚úÖ Instala y configura pgvector
- ‚úÖ Crea base de datos `cortexmcp`
- ‚úÖ Ejecuta migraciones SQL
- ‚úÖ Inserta tool de ejemplo (`get_weather`)
- ‚úÖ Crea flow de orquestaci√≥n de ejemplo
- ‚úÖ Descarga modelo Ollama

### **Opci√≥n 2: Instalaci√≥n Manual**

   ```bash
# 1. Instalar dependencias
pnpm install

# 2. Crear base de datos
createdb cortexmcp

# 3. Configurar pgvector
psql -U postgres -d cortexmcp -c "CREATE EXTENSION vector;"

# 4. Ejecutar migraciones
psql -U postgres -d cortexmcp -f packages/database/migrations/001_initial_schema.sql
psql -U postgres -d cortexmcp -f packages/database/migrations/002_multi_instance_channels.sql

# 5. Compilar proyecto
   pnpm build

# 6. Iniciar servicios
pnpm dev
```

---

## ‚öôÔ∏è Configuraci√≥n

### **Variables de Entorno Principales**

Edita tu archivo `.env`:

```bash
# ==========================================
# DATABASE
# ==========================================
DB_HOST=localhost
DB_PORT=5432
DB_NAME=cortexmcp  # ¬°Sin guion bajo!
DB_USER=postgres
DB_PASSWORD=postgres

# ==========================================
# REDIS
# ==========================================
REDIS_HOST=localhost
REDIS_PORT=6379

# ==========================================
# OLLAMA (Local LLM - Recomendado para empezar)
# ==========================================
OLLAMA_BASE_URL=http://localhost:11434
OLLAMA_MODEL=llama3.2:latest
# Otros modelos: llama3:8b, mistral:latest, gpt-oss:20b

# ==========================================
# OPENAI (Opcional)
# ==========================================
OPENAI_API_KEY=sk-...
OPENAI_MODEL=gpt-4

# ==========================================
# ANTHROPIC (Opcional)
# ==========================================
ANTHROPIC_API_KEY=sk-ant-...
ANTHROPIC_MODEL=claude-3-5-sonnet-20241022

# ==========================================
# WHATSAPP - UltrMsg
# ==========================================
WHATSAPP_PROVIDER=ultramsg
WHATSAPP_ULTRAMSG_INSTANCE_ID=instance123456
WHATSAPP_ULTRAMSG_TOKEN=your_token_here
WHATSAPP_PHONE_NUMBER=593997369006
# WHATSAPP_WEBHOOK_SECRET=optional_secret

# ==========================================
# SENDGRID (Para tool send_email)
# ==========================================
SENDGRID_API_KEY=SG.xxx
EMAIL_FROM=noreply@yourdomain.com

# ==========================================
# LEADBOX (Para tool send_leadbox_lead)
# ==========================================
LEADBOX_API_TOKEN=your_leadbox_token
```

### **Puertos del Sistema**

| Servicio | Puerto | URL |
|----------|--------|-----|
| API Backend | 3000 | http://localhost:3000 |
| Admin Frontend | 5174 | http://localhost:5174 |
| WebChat WebSocket | 3078 | ws://localhost:3078 |
| PostgreSQL | 5432 | localhost:5432 |
| Redis | 6379 | localhost:6379 |
| Ollama | 11434 | http://localhost:11434 |

---

## üíª Uso del Sistema

### **1. Iniciar el Sistema**

```bash
# Terminal 1: Backend
cd /Users/ivan/Workdir/Personal/Proyectos/CortexAgentHub
pnpm dev

# El comando anterior inicia:
# - API Service (puerto 3000)
# - Admin Frontend (puerto 5174)
# - WebChat WebSocket (puerto 3078)
```

### **2. Acceder a la Admin UI**

Abre tu navegador en: **http://localhost:5174**

P√°ginas disponibles:
- **Dashboard** (`/`) - M√©tricas en tiempo real
- **Channels** (`/channels`) - Configurar WhatsApp, Telegram, etc.
- **LLMs** (`/llms`) - Gestionar proveedores de IA
- **Tools** (`/tools`) - Crear y editar herramientas din√°micas
- **Agents** (`/agents`) - Configurar agentes especializados
- **Playground** (`/playground`) - Probar conversaciones
- **Analytics** (`/analytics`) - Estad√≠sticas y m√©tricas
- **Logs** (`/logs`) - Ver logs del sistema

### **3. Crear tu Primer Agente**

1. Ve a **Agents** ‚Üí **+ New Agent**
2. **Basic Tab**:
   - Name: "Asistente de Ventas"
   - Channel: Selecciona "WHATSAPP - 593997369006"
   - LLM: "ollama / llama3.2:latest"
   - Temperature: 0.7
3. **System Prompt Tab**:
   ```
   Eres un asistente de ventas profesional y amigable.
   Tu objetivo es ayudar a los clientes a encontrar productos
   y cerrar ventas. Siempre s√© cort√©s y proactivo.
   ```
4. **Tools Tab**:
   - ‚úÖ get_weather
   - ‚úÖ send_leadbox_lead
5. **Routing Tab**:
   - Pattern: `.*` (responde a todo)
   - Priority: 1
6. Click **Create Agent**

### **4. Probar en el Playground**

1. Ve a **Playground** (`/playground`)
2. Selecciona tu canal: "webchat"
3. Selecciona tu agente: "Asistente de Ventas"
4. Env√≠a mensaje: "¬øCu√°l es el clima en Quito?"
5. El AI invocar√° autom√°ticamente `get_weather` y responder√°

---

## üõ†Ô∏è Sistema de Tools Din√°micas

### **¬øQu√© son las Tools?**

Las tools son funciones JavaScript que el AI puede invocar para realizar acciones espec√≠ficas:
- Llamar APIs externas
- Consultar bases de datos
- Enviar emails
- Registrar leads
- Calcular resultados

### **Caracter√≠sticas del Sistema**

- ‚úÖ **100% Database-Driven** - Sin archivos hardcodeados
- ‚úÖ **Editor Monaco** - Como VS Code en el navegador
- ‚úÖ **Syntax Highlighting** - JavaScript con colores
- ‚úÖ **Autocomplete** - Ctrl+Space para sugerencias
- ‚úÖ **Real-Time Testing** - Prueba antes de guardar
- ‚úÖ **Hot-Reload** - Cambios instant√°neos
- ‚úÖ **Type Safety** - Validaci√≥n de par√°metros

### **Utilidades Disponibles en Tools**

Tu c√≥digo JavaScript tiene acceso a:

```javascript
// ‚úÖ DISPONIBLE
fetch(url, options)              // Cliente HTTP nativo
logger.info(msg, meta)           // Logging (.warn, .error)
db.query(sql, values)            // PostgreSQL (solo SELECT)
utils.sleep(ms)                  // Pausar ejecuci√≥n
utils.formatDate(date)           // Formatear fechas
utils.parseJSON(str)             // Parsear JSON
parameters                       // Par√°metros del AI
context                          // Contexto de la conversaci√≥n

// ‚ùå NO DISPONIBLE
require()                        // No se puede importar m√≥dulos
import                           // No se puede usar ES6 imports
nodemailer, axios, etc.          // No hay m√≥dulos npm
```

### **Tools Pre-configuradas**

| Tool | Descripci√≥n | Uso |
|------|-------------|-----|
| `get_weather` | Obtiene clima de una ciudad | API Open-Meteo |
| `send_email` | Env√≠a emails | SendGrid API |
| `send_leadbox_lead` | Registra leads | Leadbox.ec API |
| `calculate` | C√°lculos matem√°ticos | JavaScript nativo |
| `web_search` | B√∫squeda web | API externa |
| `execute_sql` | Consultas DB | PostgreSQL |
| `fetch_user_data` | Datos de usuario | DB query |
| `schedule_reminder` | Recordatorios | Interno |
| `search_knowledge_base` | RAG search | pgvector |

### **Ejemplo: Crear una Tool**

1. Ve a **Tools** ‚Üí **+ New Tool**
2. Name: `calculate_discount`
3. Description: "Calcula descuento sobre un precio"
4. Parameters:
```json
{
  "type": "object",
  "required": ["price", "discount_percent"],
  "properties": {
    "price": {
      "type": "number",
      "description": "Precio original"
    },
    "discount_percent": {
      "type": "number",
      "description": "Porcentaje de descuento (0-100)"
    }
  }
}
```
5. Implementation:
```javascript
async function handler(parameters) {
  if (parameters.discount_percent < 0 || parameters.discount_percent > 100) {
    throw new Error('Discount must be between 0 and 100');
  }

  const discount = parameters.price * (parameters.discount_percent / 100);
  const final_price = parameters.price - discount;

  logger.info('Discount calculated', {
    price: parameters.price,
    discount: discount,
    final_price: final_price
  });

  return {
    original_price: parameters.price,
    discount_percent: parameters.discount_percent,
    discount_amount: discount,
    final_price: final_price,
    savings: discount
  };
}
```
6. Channels: Selecciona donde estar√° disponible
7. Click **Create Tool**
8. ¬°Listo! Ahora el AI puede calcular descuentos

---

## ü§ñ Agentes Especializados

### **Concepto de Agentes**

Un **Agente** es un "Orchestration Flow" presentado de forma amigable. Define:
- üß† **LLM a usar** (OpenAI, Ollama, etc)
- üõ†Ô∏è **Tools disponibles** (solo las que necesita)
- üìù **System Prompt** (su personalidad y conocimiento)
- üéØ **Routing** (cu√°ndo debe responder)
- üì± **Canal** (WhatsApp, Telegram, etc)

### **Casos de Uso**

#### **Agente de Soporte T√©cnico**
```
System Prompt:
"Eres un especialista en soporte t√©cnico. Ayuda a resolver 
problemas de software y hardware. S√© paciente y claro."

Tools:
- search_knowledge_base (buscar soluciones)
- create_ticket (crear ticket)
- fetch_user_data (ver historial)

Channel: WebChat
Routing: .* (responde a todo)
```

#### **Agente de Ventas**
```
System Prompt:
"Eres un experto en ventas. Tu objetivo es entender las 
necesidades del cliente y recomendar productos. S√© persuasivo."

Tools:
- search_products (buscar productos)
- check_stock (verificar inventario)
- send_leadbox_lead (registrar lead)
- calculate_discount (calcular descuento)

Channel: WhatsApp
Routing: .*(precio|producto|comprar).* (keywords de ventas)
```

#### **Agente de Citas M√©dicas**
```
System Prompt:
"Eres un asistente m√©dico virtual. Ayuda a agendar citas,
consultar horarios y responder preguntas b√°sicas."

Tools:
- check_availability (ver agenda)
- schedule_appointment (agendar cita)
- send_reminder (enviar recordatorio)
- send_email (confirmaci√≥n)

Channel: Telegram
Routing: .*(cita|doctor|consulta).* (keywords m√©dicas)
```

### **Multi-Agente en un Canal**

Puedes tener m√∫ltiples agentes en el mismo canal:

```
WhatsApp (593997369006):
‚îú‚îÄ‚îÄ Agente Ventas (priority: 1, regex: .*(precio|comprar).*)
‚îú‚îÄ‚îÄ Agente Soporte (priority: 2, regex: .*(ayuda|problema).*)
‚îî‚îÄ‚îÄ Agente General (priority: 3, regex: .*)

El sistema selecciona el agente por:
1. Coincidencia de regex
2. Mayor prioridad (menor n√∫mero = mayor prioridad)
```

---

## üì± Multi-Instancia WhatsApp

### **Problema Resuelto**

Antes: Un agente = Un n√∫mero WhatsApp

Ahora: Un agente = M√∫ltiples n√∫meros WhatsApp

### **C√≥mo Funciona**

1. **Configurar Canales** (`/channels`):
   ```
   Canal 1:
   - Type: WhatsApp
   - Instance ID: instance_ventas
   - Phone: 593997369006
   
   Canal 2:
   - Type: WhatsApp
   - Instance ID: instance_soporte
   - Phone: 593987654321
   ```

2. **Crear Agentes** (`/agents`):
   ```
   Agente Ventas:
   - Channel: WHATSAPP - instance_ventas (593997369006)
   - LLM: ollama/llama3:8b
   - Tools: send_leadbox_lead, calculate_discount
   
   Agente Soporte:
   - Channel: WHATSAPP - instance_soporte (593987654321)
   - LLM: openai/gpt-4
   - Tools: search_knowledge_base, create_ticket
   ```

3. **Configurar Webhook en UltrMsg**:
   ```
   URL: https://your-domain.com/webhooks/whatsapp
   Event: message_received
   ```

4. **El Router Discrimina**:
   ```javascript
   // Mensaje llega de 593997369006
   ‚Üí FlowBasedMessageRouter detecta instance_identifier
   ‚Üí Selecciona Agente Ventas
   ‚Üí Responde con ollama/llama3:8b
   
   // Mensaje llega de 593987654321
   ‚Üí FlowBasedMessageRouter detecta instance_identifier
   ‚Üí Selecciona Agente Soporte
   ‚Üí Responde con openai/gpt-4
   ```

---

## üîå API y Webhooks

### **Endpoints Principales**

#### **Enviar Mensaje**
```bash
POST /api/v1/messages/send
Content-Type: application/json
X-API-Key: your-api-key

{
  "channelType": "webchat",
  "userId": "user-123",
  "content": "¬øCu√°l es el clima en Madrid?"
}
```

#### **Webhook WhatsApp (UltrMsg)**
```bash
POST /webhooks/whatsapp

{
  "event_type": "message_received",
  "instanceId": "instance123",
  "data": {
    "from": "593997369006@c.us",
    "to": "593987654321@c.us",
    "body": "Hola",
    "type": "chat"
  }
}
```

#### **Webhook Telegram**
```bash
POST /webhooks/telegram

{
  "message": {
    "chat": { "id": 123456789 },
    "text": "Hola bot"
  }
}
```

### **Admin API**

```bash
# Listar Tools
GET /api/admin/tools

# Crear Tool
POST /api/admin/tools
Content-Type: application/json

{
  "name": "my_tool",
  "description": "...",
  "parameters": {...},
  "implementation": "async function handler() {...}",
  "permissions": {...}
}

# Probar Tool
POST /api/admin/tools/:id/test
Content-Type: application/json

{
  "parameters": {
    "city": "Quito"
  }
}

# Listar Agentes
GET /api/admin/flows

# Crear Agente
POST /api/admin/flows
Content-Type: application/json

{
  "name": "Sales Agent",
  "channel_id": "uuid-here",
  "llm_config_id": "uuid-here",
  "flow_config": {
    "systemPrompt": "...",
    "enabledTools": ["tool1", "tool2"]
  },
  "routing_conditions": {
    "pattern": ".*",
    "description": "Responde a todo"
  },
  "priority": 1
}
```

---

## üë®‚Äçüíª Desarrollo

### **Comandos √ötiles**

```bash
# Instalar dependencias
pnpm install

# Compilar todo
pnpm build

# Compilar un package espec√≠fico
pnpm --filter @cortex/api-service build

# Modo desarrollo (con watch)
pnpm dev

# Solo backend
pnpm --filter @cortex/api-service dev

# Solo frontend
pnpm --filter @cortex/admin-frontend dev

# Linting
pnpm lint

# Format c√≥digo
pnpm format

# Limpiar builds
pnpm clean
```

### **Estructura de un Package**

```
packages/my-package/
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ index.ts           # Exportaciones principales
‚îÇ   ‚îú‚îÄ‚îÄ types.ts           # TypeScript types
‚îÇ   ‚îî‚îÄ‚îÄ ...                # C√≥digo fuente
‚îú‚îÄ‚îÄ dist/                  # Compilado (git ignored)
‚îú‚îÄ‚îÄ package.json           # Dependencias
‚îî‚îÄ‚îÄ tsconfig.json          # Config TypeScript
```

### **Agregar una Dependencia**

```bash
# Al workspace root
pnpm add lodash

# A un package espec√≠fico
pnpm --filter @cortex/api-service add fastify

# Dependencia de desarrollo
pnpm --filter @cortex/mcp-server add -D @types/node
```

### **Crear un Nuevo Package**

```bash
mkdir -p packages/my-new-package/src
cd packages/my-new-package

# Crear package.json
cat > package.json << 'EOF'
{
  "name": "@cortex/my-new-package",
  "version": "1.0.0",
  "main": "dist/index.js",
  "types": "dist/index.d.ts",
  "scripts": {
    "build": "tsc",
    "dev": "tsc --watch"
  },
  "dependencies": {
    "@cortex/shared": "workspace:*"
  }
}
EOF

# Crear tsconfig.json
cat > tsconfig.json << 'EOF'
{
  "extends": "../../tsconfig.json",
  "compilerOptions": {
    "outDir": "dist",
    "rootDir": "src"
  },
  "include": ["src/**/*"]
}
EOF

# Crear src/index.ts
echo "export const hello = () => 'Hello from my-new-package';" > src/index.ts

# Instalar dependencias
cd ../..
pnpm install
```

---

## üêõ Troubleshooting

### **Backend no inicia**

```bash
# Verificar servicios
psql -U postgres -d cortexmcp -c "SELECT 1;"  # PostgreSQL
redis-cli ping                                 # Redis
curl http://localhost:11434/api/tags          # Ollama

# Revisar logs
tail -f /tmp/backend.log

# Matar procesos en puertos
lsof -ti:3000 | xargs kill -9  # API
lsof -ti:3078 | xargs kill -9  # WebSocket
```

### **Base de datos no existe**

```bash
# Listar bases de datos
psql -U postgres -l

# Crear base de datos
createdb cortexmcp

# Ejecutar migraciones
psql -U postgres -d cortexmcp -f packages/database/migrations/001_initial_schema.sql
```

### **Tool returna "require is not defined"**

**Problema**: Est√°s intentando usar `require()` en el c√≥digo de una tool.

**Soluci√≥n**: Usa `fetch()` para llamar APIs HTTP en lugar de m√≥dulos npm.

```javascript
// ‚ùå NO FUNCIONA
const nodemailer = require('nodemailer');

// ‚úÖ FUNCIONA
const response = await fetch('https://api.sendgrid.com/v3/mail/send', {
  method: 'POST',
  headers: { 'Authorization': `Bearer ${process.env.SENDGRID_API_KEY}` },
  body: JSON.stringify({...})
});
```

### **Ollama no responde**

```bash
# Ver modelos instalados
ollama list

# Descargar modelo
ollama pull llama3.2:latest

# Probar modelo
ollama run llama3.2:latest "Hello"

# Ver logs
tail -f ~/.ollama/logs/server.log
```

### **WhatsApp no recibe mensajes**

1. Verificar webhook en UltrMsg:
   ```
   URL: https://your-ngrok-url.ngrok.io/webhooks/whatsapp
   Event: message_received
   ```

2. Verificar token en `.env`:
   ```bash
   WHATSAPP_ULTRAMSG_TOKEN=your_token
   WHATSAPP_ULTRAMSG_INSTANCE_ID=instance123
   ```

3. Ver logs:
   ```bash
   tail -f /tmp/backend.log | grep -i whatsapp
   ```

### **Frontend muestra p√°gina en blanco**

```bash
# Limpiar cache de Vite
cd packages/admin-frontend
rm -rf node_modules/.vite
rm -rf dist

# Reinstalar y compilar
pnpm install
pnpm build
pnpm dev
```

### **"Context not found" en tool test**

**Problema**: El contexto de prueba no se cre√≥ en Redis antes de ejecutar la tool.

**Soluci√≥n**: Ya est√° corregido en la versi√≥n actual. Si persiste:

```bash
# Verificar Redis
redis-cli ping

# Ver keys en Redis
redis-cli keys "cortex:context:*"

# Reiniciar backend
lsof -ti:3000 | xargs kill -9
pnpm --filter @cortex/api-service dev
```

---

## üéì Conceptos Clave

### **Model Context Protocol (MCP)**

El MCP es la capa de abstracci√≥n que proporciona:
- **Context Management**: Estado persistente de conversaciones
- **Tool Execution**: Invocaci√≥n estructurada de funciones
- **Permission System**: Control de acceso granular
- **Resource Access**: Integraci√≥n con datos externos

### **Flow-Based Routing**

El sistema usa "flows" (agentes) para determinar:
1. **Qu√© LLM usar** para cada conversaci√≥n
2. **Qu√© tools est√°n disponibles**
3. **Qu√© personalidad/conocimiento tiene**
4. **Qu√© prioridad tiene** si hay m√∫ltiples agentes

### **Dynamic Tools**

Las tools son c√≥digo JavaScript almacenado en PostgreSQL que:
- Se carga din√°micamente al iniciar el sistema
- Se ejecuta en un entorno seguro (ExecutionEngine)
- Tiene acceso a utilidades espec√≠ficas (fetch, logger, db)
- Se actualiza sin reiniciar el sistema (hot-reload)

### **Channel Adapters**

Todos los canales implementan `IChannelAdapter`:
- Normalizan mensajes entrantes a formato interno
- Manejan autenticaci√≥n espec√≠fica del canal
- Gestionan webhooks y conexiones real-time
- Formatean respuestas para cada canal

---

## üìä Estad√≠sticas del Proyecto

```
Total de Packages:      10
L√≠neas de TypeScript:   ~25,000
Archivos .ts:           ~150
Tools Din√°micas:        9
Providers LLM:          5
Canales:                4
P√°ginas Admin UI:       7
Endpoints API:          ~30
```

---

## ü§ù Contribuir

1. Seguir TypeScript strict mode
2. Escribir tests para nuevas features
3. Usar logging estructurado (no `console.log`)
4. Documentar APIs p√∫blicas con JSDoc
5. Seguir convenci√≥n de commits

---

## üìÑ Licencia

MIT License - Ver archivo LICENSE para detalles

---

## üìû Soporte

Para preguntas o issues:
- üìß Email: support@cortexmcp.com
- üêõ GitHub Issues: [github.com/your-org/cortex-mcp/issues](https://github.com/your-org/cortex-mcp/issues)
- üìñ Docs: [docs.cortexmcp.com](https://docs.cortexmcp.com)

---

## üîó Enlaces √ötiles

- [Model Context Protocol Spec](https://modelcontextprotocol.io)
- [OpenAI API Docs](https://platform.openai.com/docs)
- [Anthropic Claude API](https://docs.anthropic.com)
- [Ollama Docs](https://ollama.ai/docs)
- [Fastify Documentation](https://www.fastify.io/)
- [React Documentation](https://react.dev/)
- [pgvector Guide](https://github.com/pgvector/pgvector)

---

**üöÄ Estado del Proyecto**: ‚úÖ **100% Funcional - Producci√≥n**

**√öltima Actualizaci√≥n**: Octubre 30, 2025

**Versi√≥n**: 1.0.0

---

*Construido con ‚ù§Ô∏è para democratizar el acceso a IA conversacional multi-canal*
